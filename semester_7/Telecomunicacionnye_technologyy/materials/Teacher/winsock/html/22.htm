<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0046)http://doc.mpv.ru/steps/mfc/net/socket/22.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="22.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 22 - Первый шаг для хакера, сканирование 
портов.</H2></FONT>
<P>Итак, задача нам нужно перебрать все порты. Смотрим код: <PRE>#include "stdafx.h"
#include "iostream.h"
#include "fstream.h"
#include "winsock2.h"
#include "iostream.h"

#pragma comment(lib,"wsock32.lib")

void ErrorInfo();

void main()
{	
	ofstream ofs;
	ofs.open("log.txt"); 
	WSADATA wsaData;
	if (WSAStartup(WINSOCK_VERSION, &amp;wsaData)) 
	{
		printf ("winsock not bi initialized !\n");
	
	}
	else 
	{
	u_short  ushTestPort;
	for (ushTestPort=2828;ushTestPort&lt; 65535;ushTestPort++)
		{
		    cout &lt;&lt; ushTestPort &lt;&lt; endl;  
			SOCKET sock;
			sock = socket(AF_INET,SOCK_STREAM,0);
				if (sock!=INVALID_SOCKET) 
					{
						SOCKADDR_IN socketaddr;
						socketaddr.sin_family = AF_INET;
						socketaddr.sin_addr.s_addr  = inet_addr("192.168.1.1"); 
						socketaddr.sin_port = htons(ushTestPort);
						int size=sizeof(socketaddr);
						sock=connect(sock,(LPSOCKADDR)&amp;socketaddr,size);
						if (sock != SOCKET_ERROR )
							{
            					cout &lt;&lt; "Port " &lt;&lt;ushTestPort &lt;&lt; endl;
								ofs &lt;&lt;"Port " &lt;&lt; ushTestPort &lt;&lt; endl;
			
							}
						else ErrorInfo();
						closesocket(sock);
					}
					else cout &lt;&lt; "error create socket" &lt;&lt; endl;
		}	
	}
	WSACleanup();
	ofs.close(); 
}


void ErrorInfo()
{
	int i=WSAGetLastError();
	int g;
	switch (i)
	{
	case WSANOTINITIALISED :
		cout &lt;&lt; "Not start WinSock" &lt;&lt; endl;
		break;
    	case WSAENETDOWN:
		cout &lt;&lt; "NetWork failed" &lt;&lt; endl;
		break;
	case WSAEADDRINUSE:
		cout &lt;&lt; "Socket in use " &lt;&lt; endl;
		break;
    	case WSAEINTR:
		cout &lt;&lt; "call  WSACancelBlockingCall" &lt;&lt; endl;
		break;
    	case WSAEADDRNOTAVAIL:
		cout &lt;&lt; "address not valid " &lt;&lt; endl;
		break;
	case WSAETIMEDOUT:
		cout &lt;&lt; "connection Time Out " &lt;&lt; endl;
		break;
    	case WSAENOTSOCK:
		cout &lt;&lt; "Not Socket " &lt;&lt; endl;
		break;
    	case WSAECONNREFUSED:
		cout &lt;&lt; "reject connection" &lt;&lt; endl;
		break;
	default:
		cout &lt;&lt; " ????? " &lt;&lt; g &lt;&lt; endl;
		cin &gt;&gt; g;
		break;
	}
}
</PRE>
<P>Итак, все самое необходимое в цикле: <PRE>for (ushTestPort=2828;ushTestPort&lt; 65535;ushTestPort++)
{
}
</PRE>
<P>Создаем сокет, указываем ему <B>IP</B> адрес и порт и связываем наш сокет с 
удаленным функцией <B>connect()</B>. Дальше может быть две ситуации. Установлено 
соединение или нет. Если просто нет такого порта, то ошибка будет. <PRE>    case WSAECONNREFUSED:
		cout &lt;&lt; "reject connection" &lt;&lt; endl;
		break;
</PRE>
<P>Именно такая ошибка. Все остальные связаны с другими причинами, а эта с 
отсутствием порта. Их много причин. Я не все обрабатываю. Посмотрите на 
<B>default</B> обработки ошибки: <PRE>default:
		cout &lt;&lt; " ????? " &lt;&lt; g &lt;&lt; endl;
		cin &gt;&gt; g;
</PRE>
<P>Ошибка неизвестна и я специально останавливаю программу, чтобы можно было 
начать с этого места. Конечно можно было сделать все лучше, только зачем ??? Это 
учебная программа и пожалуйста не пользуйтесь ею в хакерских целях. А лучше 
покажите начальству и пусть денег выделяют на защиту информации. Для этого 
пожалуйста. А защита сама напрашивается. Если зафиксирован перебор портов и хоть 
два порта перебрали, да еще за короткий промежуток времени - отрубать надо все и 
лучше сразу сервер от питания :-))) 
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/21.html">Предыдущий шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/23.html">Следующий Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="22.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
