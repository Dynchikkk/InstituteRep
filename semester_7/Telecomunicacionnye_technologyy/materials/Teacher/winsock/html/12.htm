<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0046)http://doc.mpv.ru/steps/mfc/net/socket/12.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="12.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 12 - Делаем Log файл</H2></FONT>Первым делом создадим пункт 
меню <B>Tools - Options</B>, где будем указывать всякие опции, в том числе и 
создание лог файла. Переходите на меню в вкладке <B>Resource</B> и используйте 
<B>IDR_MAINFRAME</B> для редактирования пунктов меню. Удалите меню <B>File</B> и 
<B>Edit</B>. 
<P><IMG alt="step12_1.gif (919 b)" src="12.files/step12_1.gif" border=2> 
<P>Создадим реакцию на его выбор в классе <B>CHTTPServerView</B> <PRE>void CHTTPServerView::OnToolsOptions() 
{
	// TODO: Add your command handler code here
	
}
</PRE>Надо создать диалоговое окно и создать для него класс. 
<P><IMG alt="step12_2.gif (4404 b)" src="12.files/step12_2.gif" border=2> 
<P>Установить кнопочку выбора <B>check box</B> и для неё создать переменную 
<B>BOOL m_LogFile;</B>. В конструкторе она инициализируется как <PRE>CToolsOptios::CToolsOptios(CWnd* pParent /*=NULL*/)
	: CDialog(CToolsOptios::IDD, pParent)
{
	//{{AFX_DATA_INIT(CToolsOptios)
	m_LogFile = FALSE;
	//}}AFX_DATA_INIT
}
</PRE>Заведем стандартную переменную с именем лог файла. <PRE>..........
#define PORT_ADDR 80
#define QUEUE_SIZE 25
#define NAMEFILE "FirstStepServer.log"

class CSeverWinSock 
.........
</PRE>И в классе <B>CServerWinSock</B> переменную, которая будет указывать на 
то, что нужно вести лог файл. <PRE>......
class CSeverWinSock  
{
public:
	BOOL TestLogFile;
	void SendData(LPSTR buff);
.........
</PRE>Начальная инициализация <PRE>CSeverWinSock::CSeverWinSock()
{
	TestLogFile=FALSE;
}
</PRE>Организуем вызов диалога, но сначала опишем ссылку на класс. <PRE>#include "ToolsOptios.h"

/////////////////////////////////////////////////////////////////////////////
// CHTTPServerView
</PRE>И вызов диалогового окна. <PRE>void CHTTPServerView::OnToolsOptions() 
{
	CToolsOptios ctopt;
	ctopt.m_LogFile=HTTPServer.TestLogFile;
	if (ctopt.DoModal()==IDOK) 	HTTPServer.TestLogFile=ctopt.m_LogFile;
}
</PRE>Для создания <B>log</B> файла создадим класс <B>CLogFile</B>. Используя 
этот класс мы и будет писать информацию в файл. <PRE>class CLogFile : public CFile
{
public:
	BOOL Create();
	CString csFileName;
	BOOL write(CString  writeString);
	CLogFile();
	virtual ~CLogFile();

};
</PRE>Подключим его описание к реализации класса <B>CServerWinSock</B>. <PRE>// SeverWinSock.h: interface for the CSeverWinSock class.
//
//////////////////////////////////////////////////////////////////////

....................

#include "winsock.h"
# include "LogFile.h"
Обьявим его в классе 

....
class CSeverWinSock  
{
public:
	CLogFile cLogFile;
....
</PRE>При инициализации в переменную класса <B>CLogFile</B> передаем имя файла <PRE>CSeverWinSock::CSeverWinSock()
{
	TestLogFile=FALSE;
	cLogFile.csFileName=NAMEFILE;
	cLogFile.Create(); 
}
</PRE>Процедура записи <PRE>BOOL CLogFile::write(CString writeString)
{
	CFile file(csFileName, CFile::modeNoTruncate | CFile::modeWrite);
	file.SeekToEnd(); 
	writeString=writeString+"\r\n";
	file.Write(writeString.GetBufferSetLength(writeString.GetLength()),writeString.GetLength());  
	file.Close();
	return TRUE;
}
</PRE>В проекте есть реализация всех записей в лог на данный момент. Мы 
постоянно будем расширять количество информации помещаемое в лог файл для 
изучения соединения и его процесса. Пока там отражаются только самые важные 
события. 
<P>Вот пример пример лог файла <PRE>09 : 13 :04
Start WinSock
09 : 13 :04
uuobat
09 : 13 :04
Create Soket
09 : 13 :04
bind
09 : 13 :04
WSAAsyncSelect 
09 : 13 :04
Listen 
09 : 13 :05
StopServer
09 : 13 :05
Close Socket
</PRE>
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/prog/step12.rar">Загрузить 
проект</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/11.html">Предыдущий 
шаг</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/13.html">Следующий 
Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="12.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
