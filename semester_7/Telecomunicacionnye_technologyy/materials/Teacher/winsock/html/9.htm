<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0045)http://doc.mpv.ru/steps/mfc/net/socket/9.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="9.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 9 - Посылаем документ</H2></FONT>
<H3>Создаем проект</H3>Проект мы оставим старый нам нужно внести изменения всего 
в одну функцию <B>OnServerAccept</B> 
<H3>Создаем код</H3><PRE>afx_msg LRESULT CHTTPServerView::OnServerAccept(WPARAM wParam, LPARAM lParam)
{
	CHTTPServerDoc* pDoc = GetDocument();
	ASSERT_VALID(pDoc);
	HTTPServer.clientsocket = INVALID_SOCKET;
	pDoc-&gt;csInfo = "Client Connect !!!!!"; 
	Invalidate();
	if (WSAGETASYNCERROR(lParam))
	{
		AfxMessageBox("Error detecting Client");
		return 0L;
	}
	if (WSAGETSELECTEVENT(lParam) == FD_ACCEPT)
	{
		int length=sizeof(SOCKADDR);
	
		SOCKADDR_IN socketclientaddr;
		HTTPServer.clientsocket=accept(HTTPServer.servsocket,(LPSOCKADDR)&amp;socketclientaddr, (LPINT) &amp;length);
		if (HTTPServer.clientsocket == INVALID_SOCKET)
		{
			AfxMessageBox("Invalid Client Socket");
			return 0L;
		}
          CString buff="&lt; html &gt;\n&lt; p &gt;Сайт шаг за шагом представляет\n&lt; /html &gt;\r\n";
	  HTTPServer.SendData(buff.GetBuffer(1000));
	  closesocket(HTTPServer.clientsocket);
	   
	}

	return 0L;
}
</PRE>Вот код в процедуру передаются параметры, в том числе и что произошло 
обращение <B>FD_ACCEPT</B>. В самом начале мы проверяем параметры. И если все 
нормально <B>accept</B> для создания сокета клиента. После чего можно посылать 
данные. Посылку данных я вынес в отдельную процедуру. <PRE>void CSeverWinSock::SendData(LPSTR buff)
{
	int Errors;
	Errors = send(clientsocket,(LPSTR)buff,lstrlen(buff),0);
	if (Errors == SOCKET_ERROR) AfxMessageBox("Error Send");
}
</PRE>После посылки данных сокет можно закрыть. 
<P>В большой степени абстракции можно весь данный процесс со стороны сервера 
представить как <PRE>socket()
bind()
WSAAsyncSelec()
linten()
	if accept send()
closecoket()
</PRE>Вот такой результат работы нашего сервера. Только одно предупреждение. 
После запуска подождите немного. И иногда при запросе сервер не отвечает. Но 
очень редко. Есть и еще одна мелочь. После обращения к серверу в каталоге 
<B>Windows\Internet Temporary</B> помешается временный файл. Если хотите 
тестировать удаляйте его после каждого обращения, иначе страница будет 
загружаться оттуда. Имя её будет <B>IP</B>, который вы вводили для обращения к 
серверу. 
<P><IMG alt="step9.gif (10720 b)" src="9.files/step9.gif" border=2> 
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/prog/step9.rar">Загрузить 
проект</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/8.html">Предыдущий 
шаг</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/10.html">Следующий 
Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="9.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
