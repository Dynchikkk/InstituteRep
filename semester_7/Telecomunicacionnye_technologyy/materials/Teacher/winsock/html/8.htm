<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0045)http://doc.mpv.ru/steps/mfc/net/socket/8.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="8.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 8 - Соединение с сервером</H2></FONT>
<H3>Создаем проект</H3>Запускайте <B>VC</B> и выбирайте <B>MFC AppWizard</B>, 
имя проекту дайте <B>HTTPServer</B>. На шаге 1 поставьте <B>Single Document</B>, 
на шаге 3 отключите <B>ActiveX Control</B> нам пока это не нужно, на шаге 4 
отключите всё, и жмите <B>Finish</B>. 
<H3>Создаем код</H3>Давайте на основе прошлых шагов создадим класс 
<B>CSeverWinSock</B>. Переходите в <B>ClassView</B>, нажимайте правую кнопку 
мыши и выбирайте <B>Add New Class</B>. Выбирите <B>Generic Class</B> внесите имя 
и жмите <B>OK</B>, я не буду разбирать подробности переноса, скажу только, что 
все функции <B>printf</B> поменяю на <B>AfxmessageBox</B>, и все функции из 
<B>void</B> станут <B>BOOL</B>. Посмотрите проект. Но описание класса и две 
важные функции приведу. <PRE>class CSeverWinSock  
{
public:
	CSeverWinSock();
	virtual ~CSeverWinSock();
	BOOL StartWinSock();
	BOOL SocketGetHostName();
	BOOL CreateSocket();
	BOOL LinkWindowSocket(HWND m_hWnd);
	BOOL ListenSocket();
	void CloseScoket();
    BOOL LinkSoketPort();
	BOOL StopWinSock();
	BOOL StartServer(HWND m_hWnd);
	void StopServer();
private:
	SOCKET servsocket;

};


void CSeverWinSock::StopServer()
{
 CloseScoket();
 StopWinSock();
}

BOOL CSeverWinSock::StartServer()
{
	if (!StartWinSock()) return FALSE;
        if (!SocketGetHostName()) return FALSE;
	if (!CreateSocket()) return FALSE;
	if (!LinkSoketPort()) return FALSE;
        if (!LinkWindowSocket(m_hWnd)) return FALSE;
	if (!ListenSocket()) return FALSE;
	return TRUE;
}
</PRE>Итак нам нужно запустить и остановить сервер. Мы будем это делать по 
нажатию левой кнопки мыши - запускать, правой - останавливать. Но сначала 
заведем переменную <B>csInfo</B> для вывода на экран состояния. Мы опишем её в 
классе <B>CHTTPServerDoc</B> и там же инициализируем. <PRE>.....
// Implementation
public:
	CString csInfo;
	virtual ~CHTTPServerDoc();
#ifdef _DEBUG
	virtual void AssertValid() const;
	virtual void Dump(CDumpContext&amp; dc) const;
#endif
......
BOOL CHTTPServerDoc::OnNewDocument()
{
	if (!CDocument::OnNewDocument())
		return FALSE;

	csInfo="Stop Server";

	return TRUE;
}
</PRE>В классе <B>CHTTPServerView</B> опишем вывод на экран. <PRE>void CHTTPServerView::OnDraw(CDC* pDC)
{
	CHTTPServerDoc* pDoc = GetDocument();
	ASSERT_VALID(pDoc);
	
	pDC-&gt;TextOut(10,10,pDoc-&gt;csInfo);  
}
</PRE>В классе <B>CHTTPServerView</B> заведем логическую переменную 
<B>blTestStartServer</B> и в конструкторе скажем, что она <B>FALSE</B> - типа 
сервер стоит. <PRE>CHTTPServerView::CHTTPServerView()
{
	blTestStartServer=FALSE;
}
</PRE>Добавим для класса <B>CHTTPServerView</B> реакцию на нажатие правой и 
левой кнопки мыши. А также в описание этого класса ссылку на наш заголовочный 
файл. <PRE>#pragma once
#endif // _MSC_VER &gt; 1000

#include "SeverWinSock.h"
</PRE>Включим в описание класса <B>CHTTPServerView</B> экземпляр класса 
<B>CSeverWinSock</B> <PRE>public:
	BOOL blTestStartServer;
	virtual ~CHTTPServerView();
	CSeverWinSock  HTTPServer;
#ifdef _DEBUG
</PRE>Ну вот и всё готово. Теперь можно обрабатывать нажатие мышки. <PRE>/////////////////////////////////////////////////////////////////////////////
// CHTTPServerView message handlers

void CHTTPServerView::OnLButtonDown(UINT nFlags, CPoint point) 
{
	
	if (!blTestStartServer)
	{
	if (HTTPServer.StartServer(m_hWnd))
	{
		CHTTPServerDoc* pDoc = GetDocument();
		ASSERT_VALID(pDoc);
		pDoc-&gt;csInfo = "Server Start"; 
		Invalidate();
		blTestStartServer=TRUE;
	}
	}
	CView::OnLButtonDown(nFlags, point);
}

void CHTTPServerView::OnRButtonDown(UINT nFlags, CPoint point) 
{
	
	HTTPServer.StopServer();
	CHTTPServerDoc* pDoc = GetDocument();
	ASSERT_VALID(pDoc);
	pDoc-&gt;csInfo = "Server Stop"; 
	Invalidate();
	blTestStartServer=FALSE;
	CView::OnRButtonDown(nFlags, point);
}
</PRE>Когда к серверу обратится клиент будет сгенерировано сообщение 
<B>WM_SERVER_ACCEPT</B>, отловом которого мы займемся. <PRE>BEGIN_MESSAGE_MAP(CHTTPServerView, CView)
	//{{AFX_MSG_MAP(CHTTPServerView)
	ON_WM_LBUTTONDOWN()
	ON_WM_RBUTTONDOWN()
	//}}AFX_MSG_MAP
	ON_MESSAGE(WM_SERVER_ACCEPT,OnServerAccept)
END_MESSAGE_MAP()

afx_msg LRESULT CHTTPServerView::OnServerAccept(WPARAM wParam, LPARAM lParam)
{
	CHTTPServerDoc* pDoc = GetDocument();
	ASSERT_VALID(pDoc);
	pDoc-&gt;csInfo = "Client Connect !!!!!"; 
	Invalidate();
	return 0L;
}
</PRE>Надо устранить еще одну ошибку допушенную мною в прошлом шаге, при 
указании порта в <B>LinkSoketPort</B>. Это функция конвертации. <PRE>	socketaddr.sin_port = htons(PORT_ADDR);
</PRE>Собирайте проект. Устанавливайте связь с интернетом и запускайте. 
<P>А вот теперь нужно протестировать. Я тестировал на <B>Windows 98</B> с 
удаленным доступом к <B>Internet</B>. Так как <B>IP</B> адрес динамический я его 
посмотрел используя <B>IPconfig</B> и ввел в <B>Exploler</B>. Вот смотрите 
рисунок ниже. Конечно соединение прошло, но <B>Internet Explorer</B> нечего не 
показал, хотя пытался. Конечно :-) Нужен код типа <B>Client_Read</B>, но мы его 
сделаем :-) в следующем шаге. 
<P><A href="http://doc.mpv.ru/steps/mfc/net/socket/step8.gif">Рисунок 8 
[step8.gif (15583 b)]</A> 
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/prog/step8.rar">Загрузить 
проект</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/7.html">Предыдущий 
шаг</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/9.html">Следующий 
Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="8.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
