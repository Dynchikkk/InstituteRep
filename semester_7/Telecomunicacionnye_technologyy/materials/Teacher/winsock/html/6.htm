<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0045)http://doc.mpv.ru/steps/mfc/net/socket/6.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="6.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 6 - Связь окна с сокетом для получения 
сообщений</H2></FONT>Делаем еще один проект. Ну цифры там только меняются. А 
проект такой же. 
<P>При работе сервера :-) ему будут посылаться сообщения. Вот для их получения 
необходимо указать куда они пойдут. Это делается функцией <B>WSAAsyncSelect</B>. 
Только здесь есть одна загвоздка. В этой функции есть один параметр <B>HWND</B>. 
А у нас консольное приложение. И просто так вы его не получите. Это в <B>MFC</B> 
или при чистом кодировании на <B>C</B> он получаеться автоматом. Нет уж. Здесь 
нужна функция. Мы будем находить <B>HWND</B> используя функцию <B>WIN32 API</B> 
с именем <B>FindWindow</B> она нам как раз и вернет <B>HWND</B> окна. 
<P>Эта функция находится в <B>USER32.DLL</B> для того, чтобы ею воспользоваться 
нам нужен <B>USER32.LIB</B>. Подключите её. 
<P><IMG alt="step6.gif (5057 b)" src="6.files/step6.gif" border=2> 
<P>Для того, чтобы воспользоваться именем окна его нужно знать. Так лучше самому 
его дать и не гадать. Я его определил как: <PRE>#define NAME_SERVER_SOCKET "This is HTTP server version 1.0"
А теперь функция получения HWND 

HWND GetConsoleHWND()
{
	SetConsoleTitle(NAME_SERVER_SOCKET);
	HWND hwndConsoleWindow;
	hwndConsoleWindow=FindWindow(NULL, NAME_SERVER_SOCKET);
	if (hwndConsoleWindow==0)
	{
		printf("Error Find Window");
		exit(0);
	}
	return hwndConsoleWindow;
}
</PRE>Смотрите, функцией <B>SetConsoleTitle</B> я устанавливаю своё название 
окна. И ищу это окно. 
<P>Как всегда я вынес старый шаг в функцию. <PRE>void LinkSoketPort();
</PRE>Кроме того я добавил в конец <B>main</B> функцию <B>SLEEP</B>, слишком 
быстро у меня пропадает окно :-) Хотя запускать программу можно и в сеансе <B>MS 
DOS</B>, но почему-то <B>Norton Commander</B>'а у меня нет :-))), а пользоваться 
<B>CD</B> при длинных именах каталогов мне не хочется. <PRE>void main()
{
	StartWinSock();
	WaitSocket();
	StopWinSock();
	Sleep(1000);
	printf("Cansel Work \n");
}
</PRE>Итак к делу. Вот код. <PRE>void WaitSocket()
{
	SocketGetHostName();
	CreateSocket();
	LinkSoketPort();
    	int Errors;
	Errors=WSAAsyncSelect(servsocket,GetConsoleHWND(),WM_SERVER_ACCEPT, FD_ACCEPT);
	if (Errors == SOCKET_ERROR)
	{
		printf(" AsyncSelect BAD !!! \n");
		exit(1);
	}
	else printf("God AsyncSelect  !!!!!!! \n");

	
	CloseScoket();
}
</PRE>Функция <B>WSAAsyncSelect</B> связывает сообщения сокетов с окном. <PRE>int WSAAsyncSelect ( 
  SOCKET s,
  HWND hWnd,          
  unsigned int wMsg, 
  long lEvent 
 );
</PRE>Здесь интересен параметр <B>unsigned int wMsg</B> - этот параметр говорит 
о том, какое сообщение будет послано в случае подключения к серверу. Я его 
описал вот так. <PRE>const int WM_SERVER_ACCEPT = WM_USER+1;
</PRE>При успешном выполнении функции возвращается ноль, иначе 
<B>SOCKET_ERROR</B>. 
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/prog/step6.rar">Загрузить 
проект</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/5.html">Предыдущий 
шаг</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/7.html">Следующий 
Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="6.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
