<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0046)http://doc.mpv.ru/steps/mfc/net/socket/13.html -->
<HTML><HEAD>
<META http-equiv=Content-Type content="text/html; charset=koi8-r">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY text=black vLink=blue aLink=red link=blue bgColor=white><LINK 
href="13.files/1.css" type=text/css rel=stylesheet><FONT color=red>
<H2 align=center>Шаг 13 - Расширяем информативность LOG</H2></FONT>Получить 
информацию о <B>Winsock.dll</B>, который используется на Вашем ПК можно 
анализируя стртуктуру <B>WSADATA</B>. <PRE>typedef struct WSAData {   
	WORD                    wVersion;
        WORD                    wHighVersion;
        char                    szDescription[WSADESCRIPTION_LEN+1];
        char                    szSystemStatus[WSASYS_STATUS_LEN+1];
        unsigned short          iMaxSockets;
        unsigned short          iMaxUdpDg;
        char FAR *              lpVendorInfo;
} WSADATA, FAR * LPWSADATA; 
</PRE><B>wVersion</B> - версия поддержка которой ожидается. Ведь можно 
поддерживать и младшую версию. <B>wHighVersion</B> - максимальная версия, с 
которой можно работать. Нормально когда они совпадают хотя и не обязаны. 
<B>szDescription</B> - текстовая строка с описанием. <B>szSystemStatus</B> - 
опять текстовая строка с описанием, но в приложении для типа операционной среды. 
С остальными сложнее, приложение должно проигнорировать <B>iMaxsockets</B>, 
<B>iMaxUdpDg</B>, и <B>lpVendorInfo</B> области в <B>WSAData</B>, если величина 
в <B>wVersion</B> после успешного вызова на <B>WSAStartup</B> в версии 2. 
<P>Я внес в код инициализации <B>WinSock</B> изменения <PRE>BOOL CSeverWinSock::StartWinSock()
{
	if (WSAStartup(WINSOCK_VERSION, &amp;wsaData)) 
	{
		AfxMessageBox("winsock not bi initialized !");
		LogsWrite("winsock not bi initialized !");
		WSACleanup();
		return FALSE;
	} 
	LogsWrite("Запуск WinSock");
	LogsWriteNotTime("Информация о WinSock.DLL"); 
	LogsWriteNotTime(wsaData.szDescription); 
	LogsWriteNotTime(wsaData.szSystemStatus);
	return TRUE;
}
</PRE>Появилась функция <B>LogsWriteNotTime</B>, которая пишет в <B>log</B> файл 
без указания времени. Вот она <PRE>void CSeverWinSock::LogsWriteNotTime(CString writeString)
{
if (TestLogFile)  	 cLogFile.write(writeString); 
}
</PRE>Вносим пояснения в при получении имени хоста. <PRE>BOOL CSeverWinSock::SocketGetHostName()
{
	........
	LogsWriteNotTime("Получаем имя хоста");
	LogsWrite(chInfo);
	........
}
</PRE>Дополнительная информация о создании сокета. <PRE>BOOL CSeverWinSock::CreateSocket()
{
	.............
	LogsWrite("Создали сокет");
	CString  temp;
	temp.Format(" %i", PORT_ADDR);
	LogsWriteNotTime("Порт " + temp);
	LogsWriteNotTime("Протокол по умолчанию ");
	..........
}
</PRE>так же я добавил фиксацию времени обращения клиента. <PRE>afx_msg LRESULT CHTTPServerView::OnServerAccept(WPARAM wParam, LPARAM lParam)
{
	.........
	HTTPServer.LogsWrite("Запрос соединение клиентом"); 
	..........
	  closesocket(HTTPServer.clientsocket);
	  HTTPServer.LogsWrite("Отсоединение клиента"); 
	...........
}
</PRE>Конечно расширять информативность лога надо и дальше, но пока хватит :-) 
Вот как он уже выглядит !!!! <PRE>09 : 45 :03
Запуск WinSock
Информация о WinSock.DLL
Microsoft wsock32.dll, ver2.2, 32bit of Apr 28 1998, at 19:33:24.
On Win95.
Получаем имя хоста
09 : 45 :03
Jana
09 : 45 :03
Создали сокет
Порт  80
Протокол по умолчанию 
09 : 45 :03
bind
09 : 45 :03
WSAAsyncSelect 
..........
</PRE>
<P>
<HR>

<CENTER><FONT size=2><A 
href="http://doc.mpv.ru/steps/mfc/net/socket/prog/step13.rar">Загрузить 
проект</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/12.html">Предыдущий 
шаг</A> | <A href="http://doc.mpv.ru/steps/mfc/net/socket/14.html">Следующий 
Шаг</A> | <A 
href="http://doc.mpv.ru/steps/mfc/net/socket/socket.html">Оглавление</A></FONT></CENTER>
<HR>

<CENTER><FONT size=2>By <A href="mailto:kaev@yandex.ru">Artem</A>.</CENTER>
<SCRIPT src="13.files/banners.htm"></SCRIPT>
<!-- ><!-- "><!-- '><!-- --></TEXTAREA></FORM></TITLE></COMMENT></A>
<DIV></DIV></SPAN></ILAYER></LAYER></IFRAME></NOFRAMES></STYLE></NOSCRIPT></TABLE></SCRIPT></APPLET></FONT>
<STYLE>#bn {
	DISPLAY: block
}
#bt {
	DISPLAY: block
}
</STYLE>
</BODY></HTML>
