<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Протокол надежной доставки сообщений TCP</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
</head>

<body>
<H2 align="justify">10. Протокол надежной доставки сообщений TCP</H2>
<P align="justify">В стеке протоколов TCP/IP протокол <I>TCP (Transmission Control 
  Protocol)</I> работает так же, как и протокол UDP, на транспортном уровне. Он 
  обеспечивает надежную транспортировку данных между прикладными процессами путем 
  установления логического соединения. 
<H3 align="justify"><a name="10_1"></a>10.1. Сегменты TCP</H3>
<P align="justify">Единицей данных протокола TCP является сегмент. Информация, 
  поступающая к протоколу TCP в рамках логического соединения от протоколов более 
  высокого уровня, рассматривается протоколом TCP как неструктурированный поток 
  байт. Поступающие данные буферизуются средствами TCP. Для передачи на сетевой 
  уровень из буфера "вырезается" некоторая непрерывная часть данных, называемая 
  сегментом. 
<P align="justify">В протоколе TCP предусмотрен случай, когда приложение обращается 
  с запросом о срочной передаче данных (бит PSH в запросе установлен в 1). В этом 
  случае протокол TCP, не ожидая заполнения буфера до уровня размера сегмента, 
  немедленно передает указанные данные в сеть. О таких данных говорят, что они 
  передаются вне потока - <I>out of band.</I> 
<P align="justify">Не все сегменты, посланные через соединение, будут одного и 
  того же размера, однако оба участника соединения должны договориться о максимальном 
  размере сегмента, который они будут использовать. Этот размер выбирается таким 
  образом, чтобы при упаковке сегмента в IP-пакет он помещался туда целиком, то 
  есть максимальный размер сегмента не должен превосходить максимального размера 
  поля данных IP-пакета. В противном случае пришлось бы выполнять фрагментацию, 
  то есть делить сегмент на несколько частей, для того, чтобы он вместился в IP-пакет. 
<P align="justify">Аналогичные проблемы решаются и на сетевом уровне. Для того, 
  чтобы избежать фрагментации, должен быть выбран соответствующий максимальный 
  размер IP-пакета. Однако при этом должны быть приняты во внимание максимальные 
  размеры поля данных кадров (MTU) всех протоколов канального уровня, используемых 
  в сети. Максимальный размер сегмента не должен превышать минимальное значение 
  на множестве всех MTU составной сети. 
<H3 align="justify"><a name="10_2"></a>10.2. Порты и установление TCP-соединений</H3>
<P align="justify">В протоколе TCP также, как и в UDP, для связи с прикладными 
  процессами используются порты. Номера портам присваиваются аналогичным образом: 
  имеются стандартные, зарезервированные номера (например, номер 21 закреплен 
  за сервисом FTP, 23 - за telnet), а менее известные приложения пользуются произвольно 
  выбранными локальными номерами. 
<P align="justify">Однако в протоколе TCP порты используются несколько иным способом. 
  Для организации надежной передачи данных предусматривается установление <I>логического 
  соединения</I> между двумя прикладными процессами. В рамках соединения осуществляется 
  обязательное подтверждение правильности приема для всех переданных сообщений, 
  и при необходимости выполняется повторная передача. Соединение в TCP позволяет 
  вести передачу данных одновременно в обе стороны, то есть полнодуплексную передачу. 
<P align="justify">Соединение в протоколе TCP идентифицируется парой полных адресов 
  обоих взаимодействующих процессов (оконечных точек). Адрес каждой из оконечных 
  точек включает IP-адрес (номер сети и номер компьютера) и номер порта. Одна 
  оконечная точка может участвовать в нескольких соединениях. 
<P align="justify">Установление соединения выполняется в следующей последовательности: 
<div align="justify">
  <UL type=disc>
    <LI>При установлении соединения одна из сторон является инициатором. Она посылает 
      запрос к протоколу TCP на открытие порта для передачи (active open). 
    <LI>После открытия порта протокол TCP на стороне процесса-инициатора посылает 
      запрос процессу, с которым требуется установить соединение. 
    <LI>Протокол TCP на приемной стороне открывает порт для приема данных (passive 
      open) и возвращает квитанцию, подтверждающую прием запроса. 
    <LI>Для того чтобы передача могла вестись в обе стороны, протокол на приемной 
      стороне также открывает порт для передачи (active port) и также передает 
      запрос к противоположной стороне. 
    <LI>Сторона-инициатор открывает порт для приема и возвращает квитанцию. Соединение 
      считается установленным. Далее происходит обмен данными в рамках данного 
      соединения. </LI>
  </UL>
</div>
<H3 align="justify"><a name="10_3"></a>10.3. Концепция квитирования</H3>
<P align="justify">В рамках соединения правильность передачи каждого сегмента 
  должна подтверждаться квитанцией получателя. <I>Квитирование</I> - это один 
  из традиционных методов обеспечения надежной связи. Идея квитирования состоит 
  в следующем. 
<P align="justify">Для того, чтобы можно было организовать повторную передачу 
  искаженных данных отправитель нумерует отправляемые единицы передаваемых данных 
  (далее для простоты называемые кадрами). Для каждого кадра отправитель ожидает 
  от приемника так называемую положительную квитанцию - служебное сообщение, извещающее 
  о том, что исходный кадр был получен и данные в нем оказались корректными. Время 
  этого ожидания ограничено - при отправке каждого кадра передатчик запускает 
  таймер, и если по его истечению положительная квитанция на получена, то кадр 
  считается утерянным. В некоторых протоколах приемник, в случае получения кадра 
  с искаженными данными должен отправить отрицательную квитанцию - явное указание 
  того, что данный кадр нужно передать повторно. 
<P align="justify">Существуют два подхода к организации процесса обмена положительными 
  и отрицательными квитанциями: с простоями и с организацией "окна". 
<P align="justify">Метод с простоями требует, чтобы источник, пославший кадр, 
  ожидал получения квитанции (положительной или отрицательной) от приемника и 
  только после этого посылал следующий кадр (или повторял искаженный). Из рисунка 
  6.1 видно, что в этом случае производительность обмена данными существенно снижается 
  - хотя передатчик и мог бы послать следующий кадр сразу же после отправки предыдущего, 
  он обязан ждать прихода квитанции. Снижение производительности для этого метода 
  коррекции особенно заметно на низкоскоростных каналах связи, то есть в территориальных 
  сетях. 
<P align="center"> <img src="images/img00008.gif" width="364" height="126"> 
<P align=center>Рис. 6.1. Метод подтверждения корректности передачи кадров с простоем 
  источника 
<P align="justify">Во втором методе для повышения коэффициента использования линии 
  источнику разрешается передать некоторое количество кадров в непрерывном режиме, 
  то есть в максимально возможном для источника темпе, без получения на эти кадры 
  ответных квитанций. Количество кадров, которые разрешается передавать таким 
  образом, называется размером окна. Рисунок 6.2 иллюстрирует данный метод для 
  размера окна в W кадров. Обычно кадры при обмене нумеруются циклически, от 1 
  до W. При отправке кадра с номером 1 источнику разрешается передать еще W-1 
  кадров до получения квитанции на кадр 1. Если же за это время квитанция на кадр 
  1 так и не пришла, то процесс передачи приостанавливается, и по истечению некоторого 
  тайм-аута кадр 1 считается утерянным (или квитанция на него утеряна) и он передается 
  снова. 
<P align="center"> <img src="images/img00009.gif" width="410" height="194"> 
<P align=center>Рис. 6.2. Метод "окна" - непрерывная отправка пакетов 
<P align="justify">Если же поток квитанций поступает более-менее регулярно, в 
  пределах допуска в W кадров, то скорость обмена достигает максимально возможной 
  величины для данного канала и принятого протокола. 
<P align="justify">Этот алгоритм называют алгоритмом скользящего окна. Действительно, 
  при каждом получении квитанции окно перемещается (скользит), захватывая новые 
  данные, которые разрешается передавать без подтверждения. 
<H3 align="justify"><a name="10_4"></a>10.4. Реализация скользящего окна в протоколе 
  TCP</H3>
<P align="justify">В протоколе TCP реализована разновидность алгоритма квитирования 
  с использованием окна. Особенность этого алгоритма состоит в том, что, хотя 
  единицей передаваемых данных является сегмент, окно определено на множестве 
  нумерованных байт неструктурированного потока данных, поступающих с верхнего 
  уровня и буферизуемых протоколом TCP. 
<P align="justify">Квитанция посылается только в случае правильного приема данных, 
  отрицательные квитанции не посылаются. Таким образом, отсутствие квитанции означает 
  либо прием искаженного сегмента, либо потерю сегмента, либо потерю квитанции. 
<P align="justify">В качестве квитанции получатель сегмента отсылает ответное 
  сообщение (сегмент), в которое помещает число, на единицу превышающее максимальный 
  номер байта в полученном сегменте. Если размер окна равен W, а последняя квитанция 
  содержала значение N, то отправитель может посылать новые сегменты до тех пор, 
  пока в очередной сегмент не попадет байт с номером N+W. Этот сегмент выходит 
  за рамки окна, и передачу в таком случае необходимо приостановить до прихода 
  следующей квитанции. 
<H3 align="justify"><a name="10_5"></a>10.5. Выбор тайм-аута</H3>
<P align="justify">Выбор времени ожидания (тайм-аута) очередной квитанции является 
  важной задачей, результат решения которой влияет на производительность протокола 
  TCP. 
<P align="justify">Тайм-аут не должен быть слишком коротким, чтобы по возможности 
  исключить избыточные повторные передачи, которые снижают полезную пропускную 
  способность системы. Но он не должен быть и слишком большим, чтобы избежать 
  длительных простоев, связанных с ожиданием несуществующей или "заблудившейся" 
  квитанции. 
<P align="justify">При выборе величины тайм-аута должны учитываться скорость и 
  надежность физических линий связи, их протяженность и многие другие подобные 
  факторы. В протоколе TCP тайм-аут определяется с помощью достаточно сложного 
  адаптивного алгоритма, идея которого состоит в следующем. При каждой передаче 
  засекается время от момента отправки сегмента до прихода квитанции о его приеме 
  (время оборота). Получаемые значения времен оборота усредняются с весовыми коэффициентами, 
  возрастающими от предыдущего замера к последующему. Это делается с тем, чтобы 
  усилить влияние последних замеров. В качестве тайм-аута выбирается среднее время 
  оборота, умноженное на некоторый коэффициент. Практика показывает, что значение 
  этого коэффициента должно превышать 2. В сетях с большим разбросом времени оборота 
  при выборе тайм-аута учитывается и дисперсия этой величины. 
<H3 align="justify"><a name="10_6"></a>10.6. Реакция на перегрузку сети</H3>
<P align="justify">Варьируя величину окна, можно повлиять на загрузку сети. Чем 
  больше окно, тем большую порцию неподтвержденных данных можно послать в сеть. 
  Если сеть не справляется с нагрузкой, то возникают очереди в промежуточных узлах-маршрутизаторах 
  и в конечных узлах-компьютерах. 
<P align="justify">При переполнении приемного буфера конечного узла "перегруженный" 
  протокол TCP, отправляя квитанцию, помещает в нее новый, уменьшенный размер 
  окна. Если он совсем отказывается от приема, то в квитанции указывается окно 
  нулевого размера. Однако даже после этого приложение может послать сообщение 
  на отказавшийся от приема порт. Для этого, сообщение должно сопровождаться пометкой 
  "срочно" (бит URG в запросе установлен в 1). В такой ситуации порт обязан принять 
  сегмент, даже если для этого придется вытеснить из буфера уже находящиеся там 
  данные. 
<P align="justify">После приема квитанции с нулевым значением окна протокол-отправитель 
  время от времени делает контрольные попытки продолжить обмен данными. Если протокол-приемник 
  уже готов принимать информацию, то в ответ на контрольный запрос он посылает 
  квитанцию с указанием ненулевого размера окна. 
<P align="justify">Другим проявлением перегрузки сети является переполнение буферов 
  в маршрутизаторах. В таких случаях они могут централизовано изменить размер 
  окна, посылая управляющие сообщения некоторым конечным узлам, что позволяет 
  им дифференцировано управлять интенсивностью потока данных в разных частях сети. 
<H3 align="justify"><a name="10_7"></a>10.7. Формат сообщений TCP</H3>
<P align="justify">Сообщения протокола TCP называются сегментами и состоят из 
  заголовка и блока данных. Заголовок сегмента имеет следующие поля: 
<div align="justify">
  <UL type=disc>
    <LI>Порт источника (SOURS PORT) занимает 2 байта, идентифицирует процесс-отправитель; 
    <LI>Порт назначения (DESTINATION PORT) занимает 2 байта, идентифицирует процесс-получатель; 
    <LI>Последовательный номер (SEQUENCE NUMBER) занимает 4 байта, указывает номер 
      байта, который определяет смещение сегмента относительно потока отправляемых 
      данных; 
    <LI>Подтвержденный номер (ACKNOWLEDGEMENT NUMBER) занимает 4 байта, содержит 
      максимальный номер байта в полученном сегменте, увеличенный на единицу; 
      именно это значение используется в качестве квитанции; 
    <LI>Длина заголовка (HLEN) занимает 4 бита, указывает длину заголовка сегмента 
      TCP, измеренную в 32-битовых словах. Длина заголовка не фиксирована и может 
      изменяться в зависимости от значений, устанавливаемых в поле Опции; 
    <LI>Резерв (RESERVED) занимает 6 битов, поле зарезервировано для последующего 
      использования; 
    <LI>Кодовые биты (CODE BITS) занимают 6 битов, содержат служебную информацию 
      о типе данного сегмента, задаваемую установкой в единицу соответствующих 
      бит этого поля: 
    <LI>URG - срочное сообщение; 
    <LI>ACK - квитанция на принятый сегмент; 
    <LI>PSH - запрос на отправку сообщения без ожидания заполнения буфера; 
    <LI>RST - запрос на восстановление соединения; 
    <LI>SYN - сообщение используемое для синхронизации счетчиков переданных данных 
      при установлении соединения; 
    <LI>FIN - признак достижения передающей стороной последнего байта в потоке 
      передаваемых данных. 
    <LI>Окно (WINDOW) занимает 2 байта, содержит объявляемое значение размера 
      окна в байтах; 
    <LI>Контрольная сумма (CHECKSUM) занимает 2 байта, рассчитывается по сегменту; 
    <LI>Указатель срочности (URGENT POINTER) занимает 2 байта, используется совместно 
      с кодовым битом URG, указывает на конец данных, которые необходимо срочно 
      принять, несмотря на переполнение буфера; 
    <LI>Опции (OPTIONS) - это поле имеет переменную длину и может вообще отсутствовать, 
      максимальная величина поля 3 байта; используется для решения вспомогательных 
      задач, например, при выборе максимального размера сегмента; 
    <LI>Заполнитель (PADDING) может иметь переменную длину, представляет собой 
      фиктивное поле, используемое для доведения размера заголовка до целого числа 
      32-битовых слов. </LI>
  </UL>
</div>
<P align="justify"><a href="lection_9.htm">Назад</a> | <a href="index.htm">Содержание</a> 
  | <a href="lection_11.htm">Вперед </a> 
</body>
</html>
