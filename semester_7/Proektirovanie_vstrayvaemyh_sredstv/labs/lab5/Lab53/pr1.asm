list p=16F887            ; Указываем модель микроконтроллера
include "p16F887.inc"    ; Подключаем файл с определениями регистров

ct1	EQU 0x20               ; Определяем переменные (не используются в этом коде)
ct2	EQU 0x21
ct3	EQU 0x22

	org 0x00               ; Начало программы (вектор сброса)
	goto start            ; Переход к основной программе

start:
	; УСТАНАВЛИВАЕМ ЗНАЧЕНИЕ ДЛЯ СРАВНЕНИЯ
	movlw 0x01            ; Загружаем 1 в младший байт регистра сравнения
	movwf CCPR1L          ; Записываем в CCPR1L
	movlw 0x00            ; Загружаем 0 в старший байт
	movwf CCPR1H          ; Записываем в CCPR1H

	; НАСТРОЙКА ПОРТОВ ВВОДА/ВЫВОДА
	banksel TRISC         ; Переключаемся на банк с регистром TRISC
	bcf TRISC,2           ; RC2 как выход (здесь будет сигнал при сравнении)
	bsf TRISC,3           ; RC3 как вход (запускающий сигнал)
	clrf TRISD            ; Все пины PORTD как выходы (для индикации)

	banksel CCPR1L        ; Возвращаемся в банк с регистрами CCP

	; НАСТРОЙКА ТАЙМЕРА TMR1
	clrf TMR1L            ; Обнуляем младший байт TMR1
	clrf TMR1H            ; Обнуляем старший байт TMR1
	clrf T1CON            ; Настраиваем TMR1: внутренний источник, предделитель 1:1
	clrf PIR1             ; Очищаем флаги прерываний

	; ОЖИДАНИЕ ЗАПУСКАЮЩЕГО СИГНАЛА НА RC3
	; Ждем спада сигнала (1 > 0)
m3	btfsc PORTC,3          ; Пропускаем следующую команду, если RC3 = 0
	goto m3               ; Если RC3 = 1, продолжаем ждать

	; Ждем фронта сигнала (0 > 1)
m1	btfss PORTC,3          ; Пропускаем следующую команду, если RC3 = 1
	goto m1               ; Если RC3 = 0, продолжаем ждать

	; ВКЛЮЧЕНИЕ РЕЖИМА СРАВНЕНИЯ И ЗАПУСК ТАЙМЕРА
	movlw 0x09            ; Режим сравнения: при совпадении сбросить RC2 в 0
	movwf CCP1CON         ; Записываем настройку в CCP1CON
	bsf T1CON,0           ; Включаем таймер TMR1 (бит TMR1ON)

	; ОЖИДАНИЕ СРАБАТЫВАНИЯ СРАВНЕНИЯ
m2	btfss PIR1,2           ; Проверяем флаг CCP1IF
	goto m2               ; Ждем, пока флаг не установится

	; ОСТАНОВКА МОДУЛЯ CCP1 И ТАЙМЕРА
	movlw 0x00            ; Выключаем модуль CCP1
	movwf CCP1CON
	bcf T1CON,0           ; Останавливаем таймер TMR1

	nop                   ; Пауза
	goto start            ; Повторяем цикл

	end                   ; Конец программы