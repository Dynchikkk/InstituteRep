	; захват с целью измерения длительности импульса на входе RC2 
	; таймер TMR1 считает число импульсов, поступающих на вход RC0 
	; с момента появления 1 на входе RC2 и запускается CCP1 в режиме захвата
	; по спадающему фронту импульса на входе RC2 фиксируется состояние 
	; TMR1 на выходных регистрах CCP1, останавливается таймер и модуль
	; результат в регистр D 

	list p=16F887              ; указываем целевой микроконтроллер (MPASM директива)
	include "p16F887.inc"      ; подключаем файл с именами регистров и констант

	org 0x00                   ; вектор сброса (адрес начала кода)
	 goto start                ; переход на основную метку start (начало программы)
	;org 0x08                  ; (закомментирован) — обычно вектор прерываний

start 	
	banksel CCPR1L	            ; переключиться в банк, где находится CCPR1L (выбор банков)
	clrf CCPR1L	            ; очистить младший байт регистра захвата CCPR1L (запись 0)
	clrf CCPR1H	            ; очистить старший байт регистра захвата CCPR1H (запись 0)
	banksel TMR1H			; перейти в банк с регистром
    clrf TMR1H              ; TMR1H = 0x00 
    clrf TMR1L              ; TMR1L = 0x00
	banksel PIR1	            ; переключиться в банк с регистром прерываний PIR1
	clrf PIR1	                ; очистить регистр PIR1 (сброс флагов прерываний, в т.ч. CCP1IF)
	banksel TRISC	            ; переключиться в банк с TRISC (регистром направления порта C)
	bsf TRISC,2	            ; установить TRISC<2>=1 => RC2 как вход (RC2 используется для старта/спада)
	bsf TRISC,0	            ; установить TRISC<0>=1 => RC0 как вход (RC0 = T1CKI — внешний счётчик)
	clrf PORTD	                ; обнулить регистр данных PORTD
	clrf TRISD					; установить TRISD = 0 => порт D все биты как выход
	banksel T1CON	            ; переключиться в банк с регистром управления TMR1 (T1CON)
	clrf T1CON	                ; обнулить T1CON:
	                          ; - предделитель = 1:1 (T1CKPS1:0 = 00)
	                          ; - синхронизация/флаги по умолчанию = 0
	                          ; - источник счёта = внутренний (пока) (TMR1CS = 0)
	                          ; - TMR1 выключен (TMR1ON = 0)
	bsf T1CON,1	            ; установить TMR1CS = 1 => источник счёта: внешний T1CKI (RC0)
	                        
	nop	                        ; безоперационная инструкция

 m1 btfss PORTC,2	        ; проверяем бит PORTC<2> (RC2). btfss — пропустить следующую, если =1
	goto m1	                ; если RC2 = 0 (т.е. не старт импульса), повторить опрос — ждём перехода в 1

	banksel T1CON	            ; вернуться в банк T1CON (чтобы изменить бит TMR1ON)
	bsf T1CON,0	            ; установить TMR1ON = 1 => запустить TMR1
	banksel CCP1CON	            ; переключиться в банк CCP1CON
	bsf CCP1CON,2	            ; установить бит CCP1CON<2> = 1
	                          ; Пояснение: биты CCP1CON<3:0> — это CCP1M3..CCP1M0.
	                          ; Значение 0100 (M3..M0 = 0100) — режим "захват по каждому спадющему фронту".

 m2	btfss PIR1,2	        ; ожидаем установки флага CCP1IF (PIR1<2>) — означает, что модуль CCP1 захватил значение
	goto m2	                ; если флаг ещё не установлен — продолжаем ждать (т.е. ждём спадающий фронт на RC2)

	banksel T1CON	            ; переключиться в банк T1CON, чтобы остановить таймер
	bcf T1CON,0	            ; сбросить TMR1ON = 0 => остановить TMR1 (остановка подсчёта)
	banksel CCP1CON	            ; переключиться в банк CCP1CON
	clrf CCP1CON	            ; выключить модуль CCP1 (обнуляем CCP1CON) — прекращаем режим захвата

	movf CCPR1L,0	            ; переместить младший байт результата захвата (CCPR1L) в W-аккумулятор
	movwf PORTD	            ; записать W в PORTD — вывести младшие 8 бит измерения на индикацию
	nop	                        ; безоперационная инструкция
	end	                    
