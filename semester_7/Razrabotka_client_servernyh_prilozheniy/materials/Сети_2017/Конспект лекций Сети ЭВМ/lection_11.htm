<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Протокол обмена управляющими сообщениями ICMP</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
</head>

<body>
<H2 align="justify">11. Протокол обмена управляющими сообщениями ICMP</H2>
<H3 align="justify"><a name="11_1"></a>11.1. Общая характеристика протокола ICMP</H3>
<P align="justify">Протокол обмена управляющими сообщениями <I>ICMP (Internet 
  Control Message Protocol)</I> позволяет маршрутизатору сообщить конечному узлу 
  об ошибках, с которыми машрутизатор столкнулся при передаче какого-либо IP-пакета 
  от данного конечного узла. 
<P align="justify">Управляющие сообщения ICMP не могут направляться промежуточному 
  маршрутизатору, который участвовал в передаче пакета, с которым возникли проблемы, 
  так как для такой посылки нет адресной информации - пакет несет в себе только 
  адрес источника и адрес назначения, не фиксируя адреса промежуточных маршрутизаторов. 
<P align="justify">Протокол ICMP - это протокол <I>сообщения об ошибках</I>, а 
  не протокол <I>коррекции ошибок</I>. Конечный узел может предпринять некоторые 
  действия для того, чтобы ошибка больше не возникала, но эти действия протоколом 
  ICMP не регламентируются. 
<P align="justify">Каждое сообщение протокола ICMP передается по сети внутри пакета 
  IP. Пакеты IP с сообщениями ICMP маршрутизируются точно так же, как и любые 
  другие пакеты, без приоритетов, поэтому они также могут теряться. Кроме того, 
  в загруженной сети они могут вызывать дополнительную загрузку маршрутизаторов. 
  Для того, чтобы не вызывать лавины сообщения об ошибках, потери пакетов IP, 
  переносящие сообщения ICMP об ошибках, не могут порождать новые сообщения ICMP. 
<H3 align="justify"><a name="11_2"></a>11.2. Формат сообщений протокола ICMP</H3>
<P align="justify">Существует несколько типов сообщений ICMP. Каждый тип сообщения 
  имеет свой формат, при этом все они начинаются с общих трех полей: 8-битного 
  целого числа, обозначающего тип сообщения (TYPE), 8-битного поля кода (CODE), 
  который конкретизирует назначение сообщения, и 16-битного поля контрольной суммы 
  (CHECKSUM). Кроме того, сообщение ICMP всегда содержит заголовок и первые 64 
  бита данных пакета IP, который вызвал ошибку. Это делается для того, чтобы узел-отправитель 
  смог более точно проанализировать причину ошибки, так как все протоколы прикладного 
  уровня стека TCP/IP содержат наиболее важную информацию для анализа в первых 
  64 битах своих сообщений. 
<P align="justify">Поле типа может иметь следующие значения: 
<div align="justify">
  <TABLE width="100%" border=1>
    <TBODY>
      <TR> 
        <TD align=middle colSpan=38><B>Значение</B> 
        <TD colSpan=120><B>Тип сообщения</B> 
      <TR> 
        <TD align=middle colSpan=38><B>0</B> 
        <TD colSpan=120>Эхо-ответ (Echo Replay) 
      <TR> 
        <TD align=middle colSpan=38><B>3</B> 
        <TD colSpan=120>Узел назначения недостижим (Destination Unreachable) 
      <TR> 
        <TD align=middle colSpan=38><B>4</B> 
        <TD colSpan=120>Подавление источника (Source Quench) 
      <TR> 
        <TD align=middle colSpan=38><B>5</B> 
        <TD colSpan=120>Перенаправление маршрута (Redirect) 
      <TR> 
        <TD align=middle colSpan=38><B>8</B> 
        <TD colSpan=120>Эхо-запрос (Echo Request) 
      <TR> 
        <TD align=middle colSpan=38><B>11 </B> 
        <TD colSpan=120>Истечение времени дейтаграммы (Time Exceeded for a Datagram) 
      <TR> 
        <TD align=middle colSpan=38><B>12</B> 
        <TD colSpan=120>Проблема с параметром пакета (Parameter Problem on a Datagram) 
      <TR> 
        <TD align=middle colSpan=38><B>13 </B> 
        <TD colSpan=120>Запрос отметки времени (Timestamp Request) 
      <TR> 
        <TD align=middle colSpan=38><B>14</B> 
        <TD colSpan=120>Ответ отметки времени (Timestamp Replay) 
      <TR> 
        <TD align=middle colSpan=38><B>17</B> 
        <TD colSpan=120>Запрос маски (Address Mask Request) 
      <TR> 
        <TD align=middle colSpan=38><B>18</B> 
        <TD colSpan=120>Ответ маски (Address Mask Replay) </TR>
    </TBODY>
  </TABLE>
</div>
<P align="justify">Как видно из используемых типов сообщений, протокол ICMP представляет 
  собой некоторое объединение протоколов, решающих свои узкие задачи. 
<H3 align="justify"><a name="11_3"></a>11.3. Эхо-протокол</H3>
<P align="justify">Протокол ICMP предоставляет сетевым администраторам средства 
  для тестирования достижимости узлов сети. Эти средства представляют собой очень 
  простой эхо-протокол, включающий обмен двумя типами сообщений: <I>эхо-запрос</I> 
  и <I>эхо-ответ</I>. Компьютер или маршрутизатор посылают по интерсети эхо-запрос, 
  в котором указывают IP-адрес узла, достижимость которого нужно проверить. Узел, 
  который получает эхо-запрос, формирует и отправляет эхо-ответ и возвращает сообщение 
  узлу - отправителю запроса. В запросе могут содержаться некоторые данные, которые 
  должны быть возвращены в ответе. Так как эхо-запрос и эхо-ответ передаются по 
  сети внутри IP-пакетов, то их успешная доставка означает нормальное функционирование 
  всей транспортной системы интерсети. 
<P align="justify">Во многих операционных системах используется утилита <I>ping, 
  </I>которая предназначена для тестирования достижимости узлов. Эта утилита обычно 
  посылает серию эхо-запросов к тестируемому узлу и предоставляет пользователю 
  статистику об утерянных эхо-ответах и среднем времени реакции сети на запросы. 
<H3 align="justify"><a name="11_4"></a>11.4. Сообщения о недостижимости узла назначения</H3>
<P align="justify">Когда маршрутизатор не может передать или доставить IP-пакет, 
  он отсылает узлу, отправившему этот пакет, сообщение "Узел назначения недостижим" 
  (тип сообщения - 3). Это сообщение содержит в поле кода значение, уточняющее 
  причину, по которой пакет не был доставлен. Причина кодируется следующим образом: 
<div align="justify">
  <TABLE width="100%" border=1>
    <TBODY>
      <TR> 
        <TD align=middle colSpan=34><B>Код</B> 
        <TD colSpan=123><B>Причина</B> 
      <TR> 
        <TD align=middle colSpan=34><B>0</B> 
        <TD colSpan=123>Сеть недостижима 
      <TR> 
        <TD align=middle colSpan=34><B>1</B> 
        <TD colSpan=123>Узел недостижим 
      <TR> 
        <TD align=middle colSpan=34><B>2 </B> 
        <TD colSpan=123>Протокол недостижим 
      <TR> 
        <TD align=middle colSpan=34><B>3</B> 
        <TD colSpan=123>Порт недостижим 
      <TR> 
        <TD align=middle colSpan=34><B>4</B> 
        <TD colSpan=123>Требуется фрагментация, а бит DF установлен 
      <TR> 
        <TD align=middle colSpan=34><B>5</B> 
        <TD colSpan=123>Ошибка в маршруте, заданном источником 
      <TR> 
        <TD align=middle colSpan=34><B>6</B> 
        <TD colSpan=123>Сеть назначения неизвестна 
      <TR> 
        <TD align=middle colSpan=34><B>7</B> 
        <TD colSpan=123>Узел назначения неизвестен 
      <TR> 
        <TD align=middle colSpan=34><B>8</B> 
        <TD colSpan=123>Узел-источник изолирован 
      <TR> 
        <TD align=middle colSpan=34><B>9</B> 
        <TD colSpan=123>Взаимодействие с сетью назначения административно запрещено 
      <TR> 
        <TD align=middle colSpan=34><B>10</B> 
        <TD colSpan=123>Взаимодействие с узлом назначения административно запрещено 
      <TR> 
        <TD align=middle colSpan=34><B>11</B> 
        <TD colSpan=123>Сеть недостижима для заданного класса сервиса 
      <TR> 
        <TD align=middle colSpan=34><B>12</B> 
        <TD colSpan=123>Узел недостижим для заданного класса сервиса </TR>
    </TBODY>
  </TABLE>
</div>
<P align="justify">Маршрутизатор, обнаруживший по какой-либо причине, что он не 
  может передать IP-пакет далее по сети, должен отправить ICMP-сообщение узлу-источнику, 
  и только потом отбросить пакет. Кроме причины ошибки, ICMP-сообщение включает 
  также заголовок недоставленного пакета и его первые 64 бита поля данных. 
<P align="justify">Узел или сеть назначения могут быть недостижимы из-за временной 
  неработоспособности аппаратуры, из-за того, что отправитель указал неверный 
  адрес назначения, а также из-за того, что маршрутизатор не имеет данных о маршруте 
  к сети назначения. 
<P align="justify">Недостижимость протокола и порта означают отсутствие реализации 
  какого-либо протокола прикладного уровня в узле назначения или же отсутствие 
  открытого порта протоколов UDP или TCP в узле назначения. 
<P align="justify">Ошибка фрагментации возникает тогда, когда отправитель послал 
  в сеть пакет с признаком DF, запрещающим фрагментацию, а маршрутизатор столкнулся 
  с необходимостью передачи этого пакета в сеть со значением MTU меньшим, чем 
  размер пакета. 
<H3 align="justify"><a name="11_5"></a>11.5. Перенаправление маршрута</H3>
<P align="justify">Маршрутные таблицы у компьютеров обычно являются статическими, 
  так как конфигурируются администратором сети, а у маршрутизаторов - динамическими, 
  формируемыми автоматически с помощью протоколов обмена маршрутной информации. 
  Поэтому с течением времени при изменении топологии сети маршрутные таблицы компьютеров 
  могут устаревать. Кроме того, эти таблицы обычно содержат минимум информации, 
  например, только адреса нескольких маршрутизаторов. 
<P align="justify">Для корректировки поведения компьютеров маршрутизатор может 
  использовать сообщение протокола ICMP, называемое "Перенаправление маршрута" 
  (Redirect). 
<P align="justify">Это сообщение посылается в том случае, когда маршрутизатор 
  видит, что компьютер отправляет пакет некоторой сети назначения нерациональным 
  образом, то есть не тому маршрутизатору локальной сети, от которого начинается 
  более короткий маршрут к сети назначения. 
<P align="justify">Механизм перенаправления протокола ICMP позволяет компьютерам 
  содержать в конфигурационном файле только IP-адреса его локальных маршрутизаторов. 
  С помощью сообщений о перенаправлении маршрутизаторы будут сообщать компьютеру 
  всю необходимую ему информацию о том, какому маршрутизатору следует отправлять 
  пакеты для той или иной сети назначения. То есть маршрутизаторы передадут компьютеру 
  нужную ему часть их таблиц маршрутизации. 
<P align="justify">В сообщении "Перенаправление маршрута" маршрутизатор помещает 
  IP-адрес маршрутизатора, которым нужно пользоваться в дальнейшем, и заголовок 
  исходного пакета с первыми 64 битами его поля данных. Из заголовка пакета узел 
  узнает, для какой сети необходимо пользоваться указанным маршрутизатором. 
<P align="justify"><a href="lection_10.htm">Назад</a> | <a href="index.htm">Содержание</a> 
  | <a href="lection_12.htm">Вперед </a> 
</body>
</html>
