<html><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">



<body background="../images/bgrwhite.gif">
<LINK REL="stylesheet" TYPE="text/css" HREF="../default.css">
<head>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
 <TITLE>Дэвид Дж. Брэдли</TITLE>
</head>




<h2>5.5. Функции DOS</h2>

<p>
Интерпретатор командных строк обеспечивает средства, необходимые для того, чтобы программа, написанная на языке ассемблера, начала выполняться. Кроме того, DOS уже во время выполнения программы обеспечивает доступ к файловой системе с помощью механизма функций DOS. В данном разделе объясняется, что представляют собой эти функции и как они могут быть использованы
в программе.
<p>
Программа использует функции DOS посредством программного прерывания. Благодаря этому, программа
может вызывать соответствующую служебную программу, не зная ее адреса. Нужное прерывание задается программистом. А во время инициализации DOS векторы прерывания для функций системы
определяются таким образом, чтобы они указывали на соответствующие подпрограммы. Следовательно, по мере получения других версий DOS нет необходимости вносить изменения в программы. На Фиг.5.3
приводятся векторы прерывания DOS.
<p>
<table align="center">
  <tr><th>Прерывание</th><th>Действие</th>
  <tr><td class="center">20H</td><td>Окончание программы</td></tr>
  <tr><td class="center">21H</td><td>Вызов функции (см. Фиг. 5.5)</td></tr>
  <tr><td class="center">22H</td><td>Адрес завершения</td></tr>
  <tr><td class="center">23H</td><td>Адрес CTRL-BREAK</td></tr>
  <tr><td class="center">24H</td><td>Обработчик кртической ошибки</td></tr>
  <tr><td class="center">25H</td><td>Чтение с диска по абсолютному адресу</td></tr>
  <tr><td class="center">26H</td><td>Запись на диск по абсолютному адресу</td></tr>
  <tr><td class="center">27H</td><td>Завершить, но остаться резидентно</td></tr>
</table>
<p class="center">     
Фиг. 5.3 Прерывания DOS
<p>
Некоторые прерывания фактически предназначены для пользовательских подпрограмм. Прерывания
22H, 23H и 24H являются указателями на подпрограммы, которые могут быть в программе пользователя. Эти векторы определяют программу, которая должна выполняться при наступлении
соответствующей ситуации. Например, при нажатии клавиши CTRL-BREAK DOS выполняет прерывание 23H. Обычно нажатие этой клавиши вызывает останов программы. Обычно DOS выполняет стандартную обработку соответствующих ситуаций. Если же программе нужно обрабатывать их иначе, то она может изменить вектор прерывания.
<p>
В качестве примера рассмотрим прерывание 24H - обработку неустранимой ошибки. Всякий раз обнаруживая ошибку система инициирует прерывание. Обычно соответствующий вектор указывает на программу в DOS, которая выводит на дисплей сообщение об ошибке. В случае ошибки, связанной с диском, DOS выводит сообщение о дисковой ошибке. Пользователь может по своему усмотрению сделать повторную попытку выполнения операции, вызвавшей ошибку, либо закончить выполнение, либо пропустить операцию, вызвавшую ошибку. Предположим, например, что вы пишите программу форматирования дискет. Это операция, в ходе которой на поверхности дискеты происходит физическая разметка дорожек и секторов. Вместе с форматированием дискеты проверяется
отсутствие сбойных участков. Последняя операция называется верификацией дискеты. Так как при верификации допускается присутствие на дискете одно-двух сбойных участков, то вы специальным образом помечаете эти участки, чтобы в дальнейшем их случайно не использовать. Данная программа форматирования заменяет обработку неустранимых ошибок. Вам не нужно, чтобы DOS выводила для пользователя сообщение об ошибке. Вместо этого вы хотите, чтобы обработка ошибки верификации происходила в самой программе, и соответствующий участок на диске помечался как сбойный. Для этого вы заменяете вектор прерывания в ячейке 0:0090H(24H*4) указателем на свою подпрограмму обработки ошибок. Когда DOS зафиксирует дисковую ошибку, ваша подпрограмма может пометить это место как сбойный участок, никак не уведомляя об этом пользователя.
<p>
Прерывания 25H и 26H связывают между собой две части системы. С точки зрения своей файловой структуры DOS фактически состоит из двух компонент. Одна из них, IBMBIO.COM, включает программы непосредственного доступа к аппаратным средствам. Другая, IBMDOS.COM реализует файловую систему.
Упомянутые два прерывания используются, когда компонента DOS, относящаяся к файловой системе, обращается к другой компоненте - BIO. Хотя эти прерывания и могут использоваться программистом, основное их назначение - разделить две части DOS. Прерывание 25H осуществляет чтение, а прерывание 26H - запись информации с абсолютной адресацией диска. На этом уровне обеспечивается доступ к определенным участкам диска, а не записям в файле.
<p>
Прерывания 20H и 27H обеспечивают механизм возврата управления к DOS после выполнения программы.
Прерывание 20H соответствует нормальному завершению работы программы. Прерывание 27H интересно тем, что хотя оно связано с завершением программы, занимаемая программой область памяти не возвращается обратно в распоряжение DOS. Все содержимое данной области сохраняется неизменным до тех пор, пока не будет выключено питание или выполнена переустановка системы в начальное состояние. Это удобно в тех случаях, когда нужно ввести специальную обработку прерываний, либо аналогичную функцию, которая должна сохраниться как часть системного программного обеспечения. В гл.10 будет приведен пример использования прерывания INT 27H для расширения системы. В DOS имеется особенность работы с прерываниями 20H и 27H. Их использование предпочтительней в файле
типа .COM, так как файл типа .EXE имеет существенно другой формат и использование в нем этих функций DOS немного сложнее. В следующем разделе будут рассмотрены различия между файлами типа .COM и типа .EXE и то, почему упомянутые прерывания, связанные с завершением работы программы,выполняются в них по-разному.
<p>
<table align="center">
  <tr><th>Значение в AH</th><th>Функция</th>
  <tr><td class="center">0</td><td>Завершение программы</td></tr>
  <tr><td class="center">1</td><td>Ввод с клавиатуры</td></tr>
  <tr><td class="center">2</td><td>Вывод на экран</td></tr>
  <tr><td class="center">3</td><td>Дополнительный ввод (асинхронная коммуникация)</td></tr>
  <tr><td class="center">4</td><td>дополнительный вывод</td></tr>
  <tr><td class="center">5</td><td>Вывод на принтер</td></tr>
  <tr><td class="center">6</td><td>Прямой ввод/вывод с консоли</td></tr>
  <tr><td class="center">7</td><td>Прямой ввод с консоли без эха</td></tr>
  <tr><td class="center">8</td><td>Ввод с консоли без эха</td></tr>
  <tr><td class="center">9</td><td>вывод строки</td></tr>
  <tr><td class="center">OAH</td><td>Буферизованный ввод с клавиатуры</td></tr>
  <tr><td class="center">OBH</td><td>Проверка состояния клавиатуры</td></tr>
  <tr><td class="center">OCH</td><td>Очистка буфера клавиатуры и функция # в AL</td></tr>
  <tr><td class="center">ODH</td><td>Переустановка диска</td></tr>
  <tr><td class="center">OEH</td><td>Выбор диска</td></tr>
  <tr><td class="center">OFH</td><td>Открытие файла</td></tr>
  <tr><td class="center">10H</td><td>Закрытие файла</td></tr>
  <tr><td class="center">11H</td><td>Поиск первого</td></tr>
  <tr><td class="center">12H</td><td>Поиск следующего</td></tr>
  <tr><td class="center">13H</td><td>Уничтожение файла</td></tr>
  <tr><td class="center">14H</td><td>Последовательное чтение</td></tr>
  <tr><td class="center">15H</td><td>Последовательная запись</td></tr>
  <tr><td class="center">16H</td><td>Создание файла</td></tr>
  <tr><td class="center">17H</td><td>Переименование файла</td></tr>
  <tr><td class="center">19H</td><td>Текущий диск</td></tr>
  <tr><td class="center">1AH</td><td>Установка адреса обмена с диском</td></tr>
  <tr><td class="center">1BH</td><td>Адрес таблицы размещения</td></tr>
  <tr><td class="center">21H</td><td>Прямое чтение</td></tr>
  <tr><td class="center">22H</td><td>Прямая запись</td></tr>
  <tr><td class="center">23H</td><td>Размер файла</td></tr>
  <tr><td class="center">24H</td><td>Установка записи для прямого обращения</td></tr>
  <tr><td class="center">25H</td><td>Установка вектора прерывания</td></tr>
  <tr><td class="center">26H</td><td>Создание нового програмного сегмента</td></tr>
  <tr><td class="center">27H</td><td>Прямое чтение блока</td></tr>
  <tr><td class="center">28H</td><td>Прямая запись блока</td></tr>
  <tr><td class="center">29H</td><td>Анализ имени файла</td></tr>
  <tr><td class="center">2AH</td><td>Чтение даты</td></tr>
  <tr><td class="center">2BH</td><td>Установка даты</td></tr>
  <tr><td class="center">2CH</td><td>Получение времени</td></tr>
  <tr><td class="center">2DH</td><td>Установка времени</td></tr>
</table>
<p class="center">     
Фиг. 5.4 Функции прерывания DOS 21H
<p>
Прерывание 21H является прерыванием, через которое происходит обращение к основным функциям DOS. Это прерывание обеспечивает доступ к системе ввода-вывода, управляемой DOS. На Фиг. 5.4 представлены все возможные функции, использующие это прерывание. Выбор функции в программе осуществляется с помощью записи в регистр AH нужного значения перед выполнением прерывания 21H. Параметры этих функций приводятся в приложении D руководства по DOS. Вместо подробного ознакомления мы разберем пример, в котором использованы некоторые из них. В частности, этот пример включает функции DOS, связанные с диском.

<p><div align="center"><a href="../index.html"><img src="../images/index.gif" border=0 alt=""></a></div><p></p>

</body>
</html>
