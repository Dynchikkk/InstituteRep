<html><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">



<body background="../images/bgrwhite.gif">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
 <TITLE>Дэвид Дж. Брэдли</TITLE>
<H3>7.7.2. Команды управления</H3>

<p>
Команды управления микросхемы 8087 ничего не вычисляют, однако они необходимы для управления ее работой. На Фиг. 7.12 показан листинг ассемблера команд управления сопроцессора 8087.

<p>
Многие из команд управления могут выполняться без синхронизации с микропроцессором 8088. На Фиг. 7.12 показаны эти команды в форме, ассемблированной с использованием команды WAIT, а код операции в поле комментариев изображает команды без команды WAIT. Ассемблеру сообщается о том, что операция выполняется без ожидания, с помощью символов FN в качестве первых двух символов мнемоники команды.

<p>
На Фиг. 7.13 перечислены действия всех команд управления сопроцессором 8087. Команды FENI, FDISI, FCLEX обслуживают особые ситуации в сопроцессоре 8087. В управляющем регистре содержится маска прерываний, которая выделяет те ситуации, которые могут вызвать прерывание. Маской прерываний сопроцессора 8087 в целом управляют команды FENI и FDISI; эти команды аналогичны соответственно командам STI и CLI микропроцессора 8088, за исключением того, что они управляют прерываниями только от сопроцессора 8087. Команда FCLEX сбрасывает биты особых ситуаций регистра состояния. Микросхема 8087 помнит все особые ситуации, так что если последовательность команд возбудила более одного типа ошибки, все эти ошибки будут отмечены в регистре состояния. И команда FCLEX - единственный способ сброса этих флагов.
<p>
<table align="center">
  <tr> <TH>Команда</tH> <TH>Действие</tH></tr>
  <tr> <TD>FINIT</td> <td>Инициализация 8087. Переустановка программ</td></tr>
  <tr> <TD>FENI</td> <td>Освобождение прерываний по исключительным состояниям</td></tr>
  <tr> <TD>FDISI</td> <td>Блокирование прерываний по исключительным состояниям</td></tr>
  <tr> <TD>FLDCW</td> <td>Загрузка управляющего регистра 8087 из памяти</td></tr>
  <tr> <TD>FSTCW</td> <td>Сохранение управляющего регистра 8087 в память</td></tr>
  <tr> <TD>FSTSW</td> <td>Сохранение регистра состояния 8087 в память</td></tr>
  <tr> <TD>FCLEX</td> <td>Очистка индикаторов исключительных состояний</td></tr>
  <tr> <TD>FSTENV</td> <td>Сохранить оборудование 8087 в память</td></tr>
  <tr> <TD>FLDENV</td> <td>Загрузить оборудование 8087 из памяти</td></tr>
  <tr> <TD>FSAVE</td> <td>Сохранить состояние 8087 в память</td></tr>
  <tr> <TD>FRSTOR</td> <td>Загрузить состояние 8087 из памяти</td></tr>
  <tr> <TD>FRSTOR</td> <td>Увеличеть указатель вершины стека</td></tr>
  <tr> <TD>FDECSTP</td> <td>Уменьшить указатель вершины стека</td></tr>
  <tr> <TD>FFREE</td> <td>Освободить регистр стека</td></tr>
  <tr> <TD>FNOP</td> <td>Ничего не делать</td></tr>
  <tr> <TD>FWAIT</td> <td>Идентично WAIT</td></tr>
</table>
<p class="center">
Фиг. 7.13 Управляющие действия
<p>
Мы уже рассмотрели управляющее слово и слово состояния в составе программной модели сопроцессора 8087. Команды управления FLDCW, FSTCW и FSTSW загружают и сохраняют эти регистры. Рабочая среда сопроцессора 8087 содержит все регистры микросхемы, за исключением стека данных; рабочая среда состоит из 14 байт. Рисунок 7.14 показывает структуру рабочей среды после того, как сопроцессор 8087 записал ее в память. Запись рабочей среды - это обычное действие при обработке особой ситуации в сопроцессоре 8087, так как рабочая среда содержит все данные об особых ситуациях. Один 20-битовый адрес указывает на последнюю команду, которую выполнил сопроцессор 8087. Другой адрес указывает последнюю из вызывавшихся ячеек данных. Код последней выполнявшейся сопроцессором 8087 команды тоже входит в рабочую среду.
<p>
<table align="center">
  <tr> <TH>Смещение</tH> <TH>Действие</tH> <TH>Примечание</th> </tr>
  <tr> <TD>+0</td> <td>Управляющее слово</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+2</td> <td>Слово состояния</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+4</td> <td>Слово признака</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+6</td> <td>IP15-0</td> <TD>Указатель команды</td> </tr>
  <tr> <TD>+8</td> <td>IP19-16</td> <TD>Указатель команды, Код операции</td></tr>
  <tr> <TD>+10</td> <td>OP15-0</td> <TD>Указатель операнда</td></tr>
  <tr> <TD>+12</td> <td>OP19-16</td> <TD>Указатель операнда</td></tr>
</table>
<p class="center">
Фиг. 7.14 Рабочая среда 8087
<p>
Состояние микросхемы 8087 - это рабочая среда вместе с регистрами данных. Так как в сопроцессоре 8087 имеется восемь 10-байтовых регистров, состояние содержит 94 байта. Рисунок 7.15 иллюстрирует структуру состояния сопроцессора 8087, записанного в память. Структура состояния идентична рабочей среде с добавленным в конце регистровым стеком. Программа может записать состояние сопроцессора 8087, когда происходит переключение задач, или если в обработчике прерываний потребуется использование сопроцессора 8087. Когда ранее выполнявшаяся задача снова получает управление, состояние может быть программно восстановлено.
<p>
Две команды - FINCSTP и FDECSTP - взаимодействуют с указателем стека; они перемещают его. Все данные в регистрах остаются на местах, т.е. слово &quot;этикеток&quot; не изменяется. Увеличение указателя стека не эквивалентно извлечению данных из стека, так как &quot;этикетка&quot; для этих данных все же показывает, что в регистре есть данные. Попытка загрузить какое-либо число в такой стек приведет к появлению особой ситуации - переполнению стека. Команда FFREE освобождает ячейку стека, устанавливая &quot;этикетку&quot; для этой ячейки так, что она показывает отсутствие данных в ячейке. Но команда FFREE не меняет указатель стека, и если вам просто нужно выбросить верхний элемент из стека, то в большинстве случаев это легче сделать с помощью арифметической команды.
<p>
<table align="center">
  <tr> <TH>Смещение</tH> <TH>Действие</tH> <TH>Примечание</th> </tr>
  <tr> <TD>+0</td> <td>Управляющее слово</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+2</td> <td>Слово состояния</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+4</td> <td>Слово признака</td> <TD>&nbsp;</td> </tr>
  <tr> <TD>+6</td> <td>IP15-0</td> <TD>Указатель команды</td> </tr>
  <tr> <TD>+8</td> <td>IP19-16</td> <TD>Указатель команды, Код операции</td></tr>
  <tr> <TD>+10</td> <td>OP15-0</td> <TD>Указатель операнда</td></tr>
  <tr> <TD>+12</td> <td>OP19-16</td> <TD>Указатель операнда</td></tr>
  <tr> <TD>+14</td> <td>Мантисса 15-0</td> <TD>Элемент вершины стека</td></tr>
  <tr> <TD>+16</td> <td>Мантисса 31-16</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+18</td> <td>Мантисса 47-32</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+20</td> <td>Мантисса 63-48</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+22</td> <td>Порядок 14-0</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+24</td> <td>Мантисса 15-0</td> <TD>Следующий элемент стека</td></tr>
  <tr> <TD>+26</td> <td>Мантисса 31-16</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+28</td> <td>Мантисса 47-32</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+30</td> <td>Мантисса 63-48</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+32</td> <td>Порядок 14-0</td> <TD>&nbsp;</td></tr>
  <tr> <TD>......</td> <td>........</td> <TD>...........</td></tr>
  <tr> <TD>+84</td> <td>Мантисса 15-0</td> <TD>Последний элемент стека</td></tr>
  <tr> <TD>+86</td> <td>Мантисса 31-16</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+88</td> <td>Мантисса 47-32</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+00</td> <td>Мантисса 63-48</td> <TD>&nbsp;</td></tr>
  <tr> <TD>+92</td> <td>Порядок 14-0</td> <TD>&nbsp;</td></tr>
</table>
<p class="center">
Фиг. 7.15 Состояние 8087

<p><div align="center"><a href="../index.html"><img src="../images/index.gif" border=0 alt=""></a></div><p></p>

</body>
</html>
